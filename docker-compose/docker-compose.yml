version: '3.2'
# containers
services:
  # Portainer Docker GUI 
  portainer:
    container_name: Portainer
    image: portainer/portainer
    command: -H unix:///var/run/docker.sock    
    restart: always
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - ./portainer_data:/data
    network_mode: bridge
    ports:
    - 9000:9000/tcp
  postgres:
    container_name: Vault_Postgres
    image: postgres:9.6
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: vaultuser
      POSTGRES_PASSWORD: qwe123
      POSTGRES_DB: vaultdb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vaultdb"]
      interval: 2s
      timeout: 3s
      retries: 30

  rabbit:
    container_name: Vault_Rabbit
    image: rabbitmq:3-management
    ports:
      - "5673:5672"
      - "15673:15672"
    healthcheck:
      test: ["CMD", "rabbitmqctl", "node_health_check"]
      interval: 2s
      timeout: 3s
      retries: 30

  vault:
    container_name: Vault
    image: vault
    ports:
      - "8201:8200"
    volumes:
      - ./vault/:/vault/config
    environment:
      VAULT_ADDR: http://192.168.8.140:8200
      VAULT_DEV_ROOT_TOKEN_ID: root
      SKIP_SETCAP: 1
    links:
      - postgres
      - rabbit
    command: ["/vault/config/config.sh"]
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 2s
      timeout: 3s
      retries: 30